# 低功耗技术总结 #
## 电源门控（Power Gate）
对于有低功耗需求的design，将电路分为always on domain和shut down domain，在SLEEP模式下，shut domain会掉电，alon domain常开；对于长期处于SLEEP模式下的产品，该LP策略可以有效降低功耗。（比如血糖监测、手环等传感器产品）

以Cardiff C为例，划分到alon的有：
- crgu
  - 提供至少一个常开的系统时钟，需要保证电路状态的正确切换、alon模块中必要功能在sleep时的正常运行
  - 对于LP需求，可以进一步利用clock gate、更换慢时钟sync等降低功耗
- pad（不占多少power）
- pmu
  - power manage unit，顾名思义，控制整个电路的状态切换，alon
- regfile，memory，fifo
  - 掉电丢失数据
- spi
  - 一般来说需要时刻相应用户操作，比如command、寄存器读写等；
  - 用户有操作时sck才会打开，才会有动态功耗，因此SLEEP下不占多少功耗
- int_ctrl
  - alon，需要时刻监控系统，一旦有中断触发or清除，都需要及时响应
  - 同样可以通过降低时钟频率or gate部分功能时钟来reduce power
- timer_ctrl
  - CardiffC中用于根据配置得到frame中各个slot的刷新率和cv tx的刷新率，分配slot；
  - 有slot在工作时需要通知PMU唤醒系统，空转时整个rx采样是sleep的
  - 因此它需要alon，可以通过降低时钟频率or gate部分功能时钟来reduce power
- data_monitor
- alon_mpx
  - 用于观测debug信号，只要default下不要默认选中翻转率高的信号（比如时钟），SLEEP下不占多少功耗
- alon_ana_mux
- 等等

划分到shut的有：
- afe
  - 用于产生ADC打码信号，采样ADC数据并处理；
  - sleep和idle下被shut down，因为此时不需要对ADC进行任何操作
- time_manager
  - 产生afe的控制信号，控制afe在当前slot下如何采样，data_ctrl如何打包等；结束后通知PMU掉电；可被shut
- data_ctrl
  - 用于对ADC数据打包，送给降采样模块；ADC在sleep下不工作，因此可以shut
- eprom
  - 芯片上电后load一些固定值，比如trim；此后可被shut
- shut_mpx
- shut_ana_mux

#### PG所需的器件
- Power Gate switch
- ISO隔离单元
  - 插在shut-->alon之间，保证shut掉电时的X太不会蔓延到alon(钳位到0/1)
  - 如果ISO插在shut domain内部，作为output
    - 所需的ISO cell个数少，比较好check上下电；
    - 但是走线需要引入alon的power rail，给ISO供电；
    - 注意不要在output ISO后面插入buffer，会有X态蔓延；
  - 如果ISO插在alon domain内部，作为input
    - ISO cell相对较多；
    - 走线无需引入power rail；
    - 注意将ISO cell的input设置成dont_touch，免得综合出buffer，会有X态蔓延；
- Power Gate Buffer
  - 插在alon-->shut之间，在掉电时将一些alon提供的input0/1驱动成X态，送给shut domain；(感觉可加可不加，因为shut掉电没有多少导电path，基本没有功耗开销)
- Retention Register

#### shut domain的一些信号在上下电时的行为顺序
- 关键信号：
  - da_stb_en：电源开关使能，控制LDO对shut domain的供电；
  - iso_en：隔离单元使能，使能后打断shut domian与外界的数据通路；
  - clk_en：shut时钟门控，断开后shut domain内部不再继续工作；
  - shut_rstn：shutclk_en

## 时钟门控
- ### Above模块
  对整个模块的时钟做gate
  - eg. shut domain的模块都会被PMU产生的enable做clock gate
  - eg. reg_top模块一般会做二级门控（当reg_top的系统时钟频率较高时），ckgt_en_case需要包括：寄存器可配、用户读写寄存器操作、hw=rw的寄存器等；

- ### Below模块
  - #### RTL诱导策略
    - 对于多bit寄存器的condition分支，综合工具一般会给他生成clock gate，condition成立条件即ckgt的enable；在LP工作模式下，如果该condition不成立，则该多bit寄存器的CK会被gate掉，降低动态功耗；所以rtl coding时要考虑到这个情况。
    - 对于降低多bit寄存器的翻转功耗（常见于计数器），除了RTL上诱导综合工具生成ckgt，还可以通过gate always block的时钟、降低always block的时钟频率、减少bit数、重新编码降低翻转率等方式，降低功耗
    ```
    always@(posedge clk or negedge rstn) begin
        if(~rstn)   
            tcnt <= 'd0;
        else if(~timer_on)  // sleep模式下timer_on=0，导致tcnt没有被gate掉，时钟一直在翻转
        //else if(timer_on_neg) // 单次复位，sleep模式下该condition一直不成立，tcnt的CK成功被gate掉
            tcnt <= 'd0
        else
            tcnt <= xxx
    end
    ```
  - #### 手动gate策略
  

## 同步策略

## UPF